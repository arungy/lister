<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Todo</title>
  <style>
    :root {
      --bg:#fff; --text:#222; --link:#297ef6; --link-hover-bg:#e9f1ff;
      --border:#bbb; --strike:#888;
      --flash-ok-bg:#e8f5e9; --flash-ok-text:#256029;
      --flash-err-bg:#fdecea; --flash-err-text:#b71c1c;
    }
    body{font-family:Arial,sans-serif;margin:30px 0 60px 0;padding-left:16px;
         background:var(--bg);color:var(--text);}
    h2{display:flex;align-items:center;margin-bottom:18px;gap:12px;}
    .heading-actions{display:flex;gap:10px;align-items:center;opacity:0;
         pointer-events:none;transition:opacity .25s;}
    h2:hover .heading-actions{opacity:1;pointer-events:auto;}
    .heading-action-btn{background:none;border:none;color:var(--link);
         font-size:20px;cursor:pointer;border-radius:5px;padding:6px;}
    ul{list-style-type:disc;padding-left:32px;margin-bottom:30px;}
    ul#task-list li {margin-bottom: 12px;}
    ul#task-list li:last-child {margin-bottom: 0;}
    li{line-height:1.3;cursor:pointer;}
    .completed{color:var(--strike);text-decoration:line-through;}
    .task-actions{visibility:hidden;margin-left:8px;display:inline;}
    li:hover .task-actions{visibility:visible;}
    .task-actions form{display:inline;margin-left:6px;}
    .task-actions button{color:var(--link);background:none;border:none;cursor:pointer;font-size:16px;padding:0 6px;}
    .add-task-form{opacity:0;pointer-events:none;transform:translateY(-12px);
      transition:opacity .18s,transform .18s;margin:5px 0 24px 0;display:none;gap:8px;align-items:center;}
    .add-task-form.shown{display:flex;opacity:1;pointer-events:auto;transform:none;}
    .add-task-form input[type="text"]{padding:7px 11px;font-size:16px;border:1.5px solid var(--border);border-radius:4px;width:250px;background:var(--bg);color:var(--text);}
    .add-task-form select{padding:7px 11px;font-size:16px;border:1.5px solid var(--border);border-radius:4px;}
    .add-task-form button{padding:7px 16px;font-size:16px;border-radius:4px;border:none;background:var(--link);color:#fff;cursor:pointer;}
    .cancel-btn{background:#bbb;color:#444;}
    #flash-container{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);}
    .flash{padding:10px 14px;border-radius:5px;margin-bottom:8px;box-shadow:0 2px 6px rgba(0,0,0,0.2);}
    .flash.error{background:var(--flash-err-bg);color:var(--flash-err-text);border:1px solid var(--flash-err-text);}
    .flash.success{background:var(--flash-ok-bg);color:var(--flash-ok-text);border:1px solid var(--flash-ok-text);}
  </style>
</head>
<body>
  <h2>
    arung TODO
    <span class="heading-actions">
      <button id="show-add-task" class="heading-action-btn" type="button">&#43;</button>
    </span>
  </h2>

  <form id="add-task-form" class="add-task-form" method="post" action="/add" autocomplete="off">
    <input name="text" type="text" maxlength="{{ max_task_len }}" placeholder="Type your new task..." required aria-label="Task name" id="taskInput" />
    <select name="priority" id="taskPriority" required>
      <option value="1">High</option>
      <option value="2" selected>Medium</option>
      <option value="3">Low</option>
    </select>
    <input type="hidden" name="edit_task_id" id="edit_task_id" />
    <button type="submit" id="add-submit-btn">Add</button>
    <button type="button" class="cancel-btn" id="cancel-add-task">Cancel</button>
  </form>

  <ul id="task-list">
    {% for t in tasks %}
      <li class="{% if t['completed'] %}completed{% endif %}" tabindex="0" data-task-id="{{ t['id'] }}" data-task-priority="{{ t['priority'] }}">
        {{ t['text'] }}
        <span class="task-actions">
          <form method="post" action="/toggle/{{ t['id'] }}">
            <button title="Toggle Complete">&#10003;</button>
          </form>
          <form method="post" action="/delete/{{ t['id'] }}">
            <button onclick="return confirm('Delete this task?');" title="Delete">&#128465;</button>
          </form>
        </span>
      </li>
    {% endfor %}
  </ul>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div id="flash-container">
        {% for category,msg in messages %}
          <div class="flash {{ category }}">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Flash auto-dismiss
      const flashContainer=document.getElementById('flash-container');
      if(flashContainer){setTimeout(()=>{
        flashContainer.querySelectorAll('.flash').forEach(el=>{
          el.style.opacity='0';setTimeout(()=>el.remove(),800);
        });},2500);}

      const addBtn=document.getElementById('show-add-task');
      const addForm=document.getElementById('add-task-form');
      const addInput=document.getElementById('taskInput');
      const editId=document.getElementById('edit_task_id');
      const submitBtn=document.getElementById('add-submit-btn');
      const cancelBtn=document.getElementById('cancel-add-task');
      const priorityInput=document.getElementById('taskPriority');

      addBtn.addEventListener('click',()=>{
        addForm.style.display='flex';
        setTimeout(()=>addForm.classList.add('shown'),10);
        addBtn.style.display='none';
        addInput.value=''; editId.value=''; submitBtn.textContent='Add';
        addForm.action='/add'; addInput.focus();
        priorityInput.value='2';
      });

      cancelBtn.addEventListener('click',()=>{
        addForm.classList.remove('shown');
        setTimeout(()=>{addForm.style.display='none'; addBtn.style.display='flex';},180);
        addInput.value=''; editId.value=''; submitBtn.textContent='Add'; addForm.action='/add';
        priorityInput.value='2';
      });

      addInput.addEventListener('keydown',e=>{ if(e.key==='Escape') cancelBtn.click(); });

      // Double-click edit
      document.querySelectorAll('li[data-task-id]').forEach(li=>{
        li.addEventListener('dblclick',()=>{
          addForm.style.display='flex';
          setTimeout(()=>addForm.classList.add('shown'),10);
          addBtn.style.display='none';
          addInput.value=li.childNodes[0].textContent.trim();
          editId.value=li.dataset.taskId;
          submitBtn.textContent='Update';
          addForm.action='/edit/'+encodeURIComponent(li.dataset.taskId);
          priorityInput.value=li.getAttribute('data-task-priority') || "2";
          addInput.focus();
        });
      });
    });
  </script>
</body>
</html>
